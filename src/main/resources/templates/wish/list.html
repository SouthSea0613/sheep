<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script defer src="/javascript/common.js"></script>
    <script src="https://kit.fontawesome.com/3e18228bfa.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/css/headerfooter.css">
    <link rel="stylesheet" href="/css/wish.css">
    <script>
        const user = "[[${session?.user_id}]]";
        const type = "[[${session?.user_type}]]";

        $(() => {
            userType();
            loginStatus();
            createbtn();
        })

        function wish_write() {
            location.href = "/wish/write"
        }

        function takeoff(btn) {
            const wishnumber = btn.previousElementSibling.value;
            axios.post('/takeoff/call', {
                user_id: "[[${session.user_id}]]",
                wish_number: wishnumber,
                apply_status: "0",
            }).then((res) => {
                if (res) {
                    alert("견적 요청이 완료되었습니다")
                    location.href = "/wish/list";
                } else {
                    alert("견적 요청이 실패되었습니다");
                    location.href = "/wish/list";
                }
            });
        }
        function contract(){
            const wishnumber = document.querySelectorAll('.hidden_wish_number')
            const userid = document.querySelectorAll('.hidden_user_id')
            for(let i=0; i<wishnumber.length; i++){
                axios.post('/takeoff/contract',{
                    wish_number: wishnumber[i].value,
                    user_id: userid[i].value,
                }).then((res)=>{
                    if(res.data) {
                        alert("계약이 완료되었습니다");
                        history.go(0);
                    }else{
                        alert("계약이 실패했습니다");
                    }
                })
            }
        }
        function takeofflist(btn) {
            const takeofflist = document.querySelector('.takeoff_list');
            const openbtn = document.querySelector('.openbtn');
            const closebtn = document.querySelector('.closebtn');
            const confirmbtn = document.querySelector('#confirmbtn');
            const contractbtn = document.querySelectorAll('.contractbtn');
                if (btn === openbtn) {
                    const wishnumber = btn.previousElementSibling.value
                    confirmbtn.style.display = "block";
                    console.log(wishnumber);
                    openbtn.style.display = "none";
                    closebtn.style.display = "block";
                    axios.post('/takeoff/list', {
                        wish_number: wishnumber
                    }).then((res) => {
                        closebtn.style.display = 'block';
                        btn.style.display = 'none';
                        console.log(res.data)
                        console.log(takeofflist)

                        res.data.forEach(resp => {
                            takeofflist.innerHTML += '<div class="takeoffdiv">' + '<span>' + '<a href="/takeoff/seller/detail?wish_number=' + wishnumber + '&user_id=' + resp.user_id + '" th:href="@{/takeoff/detail(wish_number=' + wishnumber + ')}" th:text="' + resp.seller_company + '">' + resp.seller_company + '</a>' + '</span>'
                            takeofflist.innerHTML += '<span>' + resp.wish_category_seller_price + "만원" + '</span>' + '</div>';
                            takeofflist.innerHTML += '<span class="status">' + resp.apply_status + '</span>';
                            if (resp.apply_status === "상담중") {
                                takeofflist.innerHTML += '<input class="hidden_wish_number" type="hidden" value=' + resp.wish_number + '>'
                                takeofflist.innerHTML += '<input class="hidden_user_id" type="hidden" value=' + resp.user_id + '>'
                            }
                        })
                        buttonstatus();
                    })
                }
                else if (btn === closebtn) {
                    btn.style.display = 'none';
                    openbtn.style.display = 'block';
                    closebtn.style.display="none";
                    takeofflist.innerHTML = "";
                    confirmbtn.style.display="none";
                    contractbtn.forEach(cbtn=>{
                        cbtn.style.display="none";
                    })
                }

        }

        function createbtn() {
            const btndiv = document.querySelectorAll('.status_wish_number')
            for (let i = 0; i < btndiv.length; i++) {
                axios.post('/takeoff/count', null, {
                    params: {
                        wish_number: btndiv[i].value,
                        user_id: "[[${session.user_id}]]"
                    }
                })
                    .then((res) => {
                        if (res.data) {

                        } else {
                        }
                    })
            }
        }

        function confirm(){
            const wishnumber = document.querySelector('.hidden_wish_number')
            const takeofflist = document.querySelector('.takeoff_list');
            const contractbtn = document.querySelectorAll('.contractbtn');
            const status = document.querySelectorAll('.status');
            const confirmbtn = document.getElementById('confirmbtn')
            console.log(wishnumber)
            for(let i=0; i<5;i++){
                if(status[i].innerText==="상담중"){
                    axios.post('/takeoff/confirm',{
                        user_id : "[[${session.user_id}]]",
                        wish_number : wishnumber.value,
                    }).then((res)=>{
                        if(res.data){
                            alert("견적이 확정되었습니다.")
                            takeofflist.style.display = "block";
                            contractbtn[i].style.display = 'block';
                            confirmbtn.style.display="none";

                        }else{
                            alert("견적확정이 실패했습니다.")
                        }
                    })
                }
            }

        }
        function buttonstatus(){
            const wishnumber = document.querySelector('.wish_number_status').value
            const contractbtn = document.querySelectorAll('.contractbtn');
            const status = document.querySelectorAll('.status');
            const confirmbtn = document.getElementById('confirmbtn')
            console.log(status[1])
            axios.post('/takeoff/getstatus',{
                wish_number: wishnumber,
                user_id :"[[${session.user_id}]]",
            }).then(res=>{
                switch (res.data.apply_status){
                    case "0":
                        break;
                    case "1":
                        confirmbtn.style.display="none";
                        for(let i=0; i<5;i++) {
                            if (status[i].innerText === "상담중") {
                                contractbtn[i].style.display = "block";
                            }
                        }
                        break;
                    case "2":
                        confirmbtn.style.display="none";
                        for(let i=0; i<5;i++) {
                            contractbtn[i].style.display = "none";
                        }
                        break;
                    case "3":
                        confirmbtn.style.display="none";
                        break;
                    case "4":
                        confirmbtn.style.display="none";
                        break;
                }
            })
        }
        let num = 0;
        function endwish(){
            const endwish = document.querySelector('.endwish')
            const endwish_container = document.querySelector('.endwish_container')
            const wish_ing_container = document.querySelector('.all_wish')
            const buttondiv = document.querySelectorAll('.button_endlist')
            console.log(buttondiv)
            if(num===0){
            axios.post('/takeoff/endwish',{
            })
                .then((res)=>{
                    wish_ing_container.style.display='none';
                    endwish_container.style.display="block";
                    endwish.innerHTML+= '<input type="hidden" class="end_wish_number" value="'+res.data.wish_number+'"' +'>';
                    endwish.innerHTML+= '<span>'+res.data.wish_title+'</span>'
                    endwish.innerHTML+= '<span>'+res.data.apply_status+'</span>'
                    endwish.innerHTML+= '<div class="endlist"></div>'
                        buttondiv.forEach(div=>{
                            console.log(div)
                            div.innerHTML += '<i class="fa-solid fa-caret-down fa-2xl openbtn2" onClick="takeoffendlist(this)"></i>'
                            div.innerHTML += '<i style="display: none" class="fa-solid fa-caret-up fa-2xl closebtn2" onClick="takeoffendlist(this)"></i>'
                        })
                    num=1;
                })
            }
        }
        function ingtab(){
            const buttondiv = document.querySelectorAll('.button_endlist')
            const wish_ing_container = document.querySelector('.all_wish')
            const endwish_container = document.querySelector('.endwish_container')
            const endwish_div = document.querySelector('.endwish')
            buttondiv.forEach(div=>{
                div.innerHTML="";
            })
            endwish_div.innerHTML ="";
            wish_ing_container.style.display="block";
            endwish_container.style.display="none";
            num=0;
        }

        function takeoffendlist(btn) {
            const wishnumber = document.querySelectorAll('.end_wish_number')
            const openbtn = document.querySelectorAll('.openbtn2')
            const closebtn = document.querySelectorAll('.closebtn2')
            const list = document.querySelectorAll('.endlist')
            const endwish_div = document.querySelectorAll('.endwish')
            console.log("엥")
             for(let i =0; i<openbtn.length; i++){
                if(btn===openbtn[i]){
                    endwish_div.forEach(div=>{
                        div.style.display="block";
                    })
                    wishnumber.forEach(number=>{
                        console.log(number)
                    axios.post('/takeoff/endtakeoff', {
                        wish_number:number.value,
                        user_id : "[[${session.user_id}]]"
                    }).then(res=>{
                        console.log(res.data);
                        list.forEach(div=>{
                            res.data.forEach(data=>{
                            if(data.apply_status==="기간만료"){
                                div.innerHTML += '<div class="seller_class"><span>'+ data.seller_name + '</span>';
                            }else{
                                div.innerHTML += '<div class="seller_class"><span>' + '<a href="/takeoff/seller/detail?wish_number=' + data.wish_number + '&user_id=' + data.user_id + '">'+ data.seller_name + '<a/></span>';
                            }
                            div.innerHTML += '<span>' + data.wish_category_seller_price+ "만원" + '</span>';
                            div.innerHTML += '<span class="status_span">' + data.apply_status + '</span></div>'
                            linkcss()
                            })
                        })
                        closebtn[i].style.display="block";
                        openbtn[i].style.display="none";
                    })
                    })
                }else if(btn===closebtn[i]){
                    endwish_div.forEach(div=>{
                        openbtn[i].style.display="block";
                        closebtn[i].style.display="none";
                        div.style.display="none";
                    })
                }
             }
            function linkcss(){
                const seller_class = document.querySelector('.seller_class');
                seller_class.style.backgroundcolor= "gray";
            }

        }
    </script>
</head>
<body>
<th:block th:replace="~{common/fragment::header}"></th:block>
<div class="main_content">
    <h2>위시리스트</h2>

    <div class="wish-list-area">
        <th:block th:if="${#lists.isEmpty(wish_list) and #lists.isEmpty(wish_req_list)}">
            <div class="non_wish">
                <div>위시리스트가 없습니다</div>
            </div>
        </th:block>
        <div class="wishBarea wish_write_btn">
            <div class="tab">
                <input type="button" class="wish_ing" value="진행중 위시" onclick="ingtab()">
                <input type="button" class="wish_end" value="종료된 위시" onclick="endwish()">
            </div>
            <input type="button" id="wish_write" onclick="wish_write()" value="글쓰기">
        </div>
        <div class="all_wish">
        <!--위시리스트 요청 후 -->
        <th:block th:unless="${#lists.isEmpty(wish_req_list)}">
            <th:block th:each="wish:${wish_req_list}">
                <div class="wish_list_block">
                    <div class="wish_container">
                        <div class="button">
                            <div th:if="${takeoff>0}">
                            <input type="hidden" class="hidden-regwish" th:value="${wish.wish_number}">
                            <i class="fa-solid fa-caret-down fa-2xl openbtn" onclick="takeofflist(this)"></i>
                            <i style="display: none" class="fa-solid fa-caret-up fa-2xl closebtn" onclick="takeofflist(this)"></i>
                            </div>
                        </div>
                        <div class="wish_box">
                            <a class="detaillink" th:href="@{/wish/detail(wish_number=${wish?.wish_number})}"
                               th:text="${wish?.wish_title}"></a>
                        </div>
                        <div th:if="${wish?.apply_status}" id="applystatus" th:text="${wish?.apply_status}"
                             class="wish_apply_status">상태값
                        </div>
                    </div>
                        <div th:if="${wish?.apply_status!=0 or wish?.apply_status!=null}">
                            <input type="hidden" th:value="${wish?.wish_number}" class="wish_number_status"
                                   name="wish_number">
                            <div class="listbtn"></div>
                            <div class="takeoff_list">
                            </div>
                            <div><input type="button" hidden class="contractbtn" value="계약완료" onclick="contract()"></div>
                            <div><input type="button" hidden class="contractbtn" value="계약완료" onclick="contract()"></div>
                            <div><input type="button" hidden class="contractbtn" value="계약완료" onclick="contract()"></div>
                            <div><input type="button" hidden class="contractbtn" value="계약완료" onclick="contract()"></div>
                            <div><input type="button" hidden class="contractbtn" value="계약완료" onclick="contract()"></div>
                            <div class="confirmbtn_class">
                                <input type="button" id="confirmbtn" hidden value="확정" onclick="confirm()">
                            </div>
                            <div class="">
                                <input type="hidden" th:value="${wish?.wish_number}" class="status_wish_number"
                                       name="wish_number">
                                <input type="hidden" th:value="${wish?.user_id}" class="wish_user_id">
                            </div>
                        </div>
                </div>
                    <div th:unless="${wish?.apply_status!=null}" class="takeoffarea">
                        <input type="hidden" th:value="${wish?.wish_number}" class="wish_number" name="wish_number">
                        <input type="button" class="wish_takeoff" onclick="takeoff()" value="견적요청">
                    </div>
            </th:block>
        </th:block>
            <!--위시리스트(요청전)-->
            <th:block th:unless="${#lists.isEmpty(wish_list)}">
                <th:block th:each="wish:${wish_list}">
                    <div class="wish_list_block">
                        <div class="wish_container">
                            <div>
                                <a class="detaillink" th:href="@{/wish/detail(wish_number=${wish?.wish_number})}"
                                   th:text="${wish?.wish_title}"></a>
                            </div>
                            <div th:if="${wish?.apply_status!=0 or wish?.apply_status!=null}">
                                <input type="hidden" th:value="${wish?.wish_number}" class="wish_number_status"
                                       name="wish_number">
                                <div class="">
                                    <input type="hidden" th:value="${wish?.wish_number}" class="status_wish_number"
                                           name="wish_number">
                                    <input type="hidden" th:value="${wish?.user_id}" class="wish_user_id">
                                </div>
                            </div>
                        </div>
            <div th:unless="${wish?.apply_status!=null}" class="takeoffarea">
                <div th:if="${wish_req_list==null}">
                <input type="hidden" th:value="${wish?.wish_number}" class="wish_number" name="wish_number">
                <input type="button" class="wish_takeoff" onclick="takeoff(this)" value="견적요청">
                </div>
            </div>
            </div>
            </th:block>
        </th:block>
        </div>
        <div class="endwish_container" hidden>
            <div class="wish_list_block">
                <div class="takeoff_end">
                    <span class="button_endlist">
                    </span>
                    <!--종료된 위시-->
                    <div class="endwish">

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block th:replace="~{common/fragment::footer}"></th:block>
</body>
</html>